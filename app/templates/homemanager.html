<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe</title>
    <style>
        body {
            background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        #container {
            background-color: rgba(255, 255, 255, 0.9);
            
            padding: 30px;
            margin: 30px auto;
            width: 80%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        form {
           
            margin-bottom: 20px;
        }

        input[type=text] {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 4px;
            outline: none;
        }

        input[type=text]:focus {
            border: 2px solid #4CAF50;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            background-color: #ddd;
            padding: 10px;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        #queue ul {
            list-style-type: none;
            padding: 0;
        }

        #queue li {
            background-color: #eee;
            padding: 10px;
            margin-bottom: 2px;
            border-radius: 4px;
        }

    </style>
</head>
<body>
    <div id="container">
    <h1>{{ cafe.name }}</h1>

    <div id="player"></div>
    <div id="queue"></div>

    <button id="active-btn" type="button" class="btn btn-primary mb-3" onclick="toggleCafeStatus()">{% if cafe.is_active %}Active{% else %}Inactive{% endif %}</button>

    {% if cafe.is_active %}
    <form class="form-inline">
      <input type="text" id="youtube-link" name="youtube_link" class="form-control" placeholder="Paste YouTube link here">
      <button type="button" class="btn btn-success" onclick="playYouTube()">Play</button>
  </form>
    <br>
    <form id="blacklist-form" class="form-inline">
        <input type="text" id="blacklist-link" class="form-control" placeholder="Add link to blacklist">
        <button type="button" class="btn btn-danger" onclick="addToBlacklist()">Add to Blacklist</button>
    </form>
    <p>Is Active: {{ cafe.is_active }}</p>
    <p>Current Token: <span id="current-token">{{ cafe.current_token }}</span></p>
    <p>Next Token: {{ cafe.next_token }}</p>
    </ul>
    <a href="{% url 'playlists' %}" class="btn btn-primary mb-3">Playlist</a>
    <br>
    
    {% else %}
    <p>Cafe is currently inactive.</p>
    {% endif %}
</div>
{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  var current_tok;
  var player;
  var queue = [];
  var queue_token_no = [];
  var myvideoid;
  function Refresh() {   
    {% for song in songs %}
    var text = "{{ song.0 }}";
    var videoId = getYouTubeVideoId(text);
    queue.push(videoId);
    {% endfor %}
    {% for q in queue %}
        var text = "{{ q.token_no }}";
        queue_token_no.push(text);
    {% endfor %}
    console.log(queue_token_no);
    //var firstVideoId = queue[0];
    //setVideoPlayed(firstVideoId);
    playNextVideo();
  }

  async function playYouTube() {
    var youtubeLink = document.getElementById("youtube-link").value;
    
    try {
      var isSong = await isSongVideo(youtubeLink);
      console.log("is song:",isSong);
      if (isSong) {
        const durationInSeconds = await getSongDuration(youtubeLink);
        
        if (durationInSeconds > 360) {
          console.log('Song duration is greater than 6 minutes');
        } else {
          console.log('Song duration is less than or equal to 6 minutes');
          fetch('/api/play-youtube/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'youtube_link=' + encodeURIComponent(youtubeLink)
          }).then(function(response) {
            if (response.ok) {
              //console.log('YouTube video added to queue');
            } else {
              console.log('Error adding YouTube video to queue');
            }
          }).catch(function(error) {
            console.log('Network error:', error);
          });
        }
      } else {
        console.log('The provided link is not a song video');
      }
    } catch (error) {
      console.log('Error checking if the video is a song:', error);
    }
  }

  async function isSongVideo(youtubeLink) {
    try {
      const videoId = getYouTubeVideoId(youtubeLink);
      const apiKey = 'AIzaSyCNtdk5YQKiONdmp1E3HZNZsmrAs1xBY5o';
      const apiUrl = `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${apiKey}&part=snippet,contentDetails`;
  
      const response = await fetch(apiUrl);
      const data = await response.json();
  
      if (data.items.length > 0) {
        const videoCategory = data.items[0].snippet.categoryId;
        // Assuming the category ID for song videos is '10' (Music)
        if (videoCategory === '10') {
          return true; // It's a song video
        }
      }
  
      return false; // Not a song video
    } catch (error) {
      console.log('Error checking song video:', error);
      return false; // Error occurred, assume it's not a song video
    }
  }      
  
  async function getSongDuration(youtubeLink) {
    try {
      const videoId = getYouTubeVideoId(youtubeLink);
      const apiKey = 'AIzaSyCNtdk5YQKiONdmp1E3HZNZsmrAs1xBY5o';
      const apiUrl = `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${apiKey}&part=contentDetails`;
  
      const response = await fetch(apiUrl);
      const data = await response.json();
  
      if (data.items.length > 0) {
        const duration = data.items[0].contentDetails.duration;
        const durationInSeconds = parseDurationToSeconds(duration);
        return durationInSeconds;
      }
  
      return 0; // Invalid or unavailable duration
    } catch (error) {
      console.log('Error fetching song duration:', error);
      return 0; // Error occurred, assume invalid duration
    }
  }
  
  function parseDurationToSeconds(duration) {
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
  
    const hours = (parseInt(match[1]) || 0);
    const minutes = (parseInt(match[2]) || 0);
    const seconds = (parseInt(match[3]) || 0);
  
    return hours * 3600 + minutes * 60 + seconds;
  }
  

  function playNextVideo() {
    if (queue.length > 0) {
      var videoId = queue.shift();
      current_tok=queue_token_no[0];
      var currentTokenElement = document.getElementById('current-token');
      // Update the current token value
      currentTokenElement.textContent = current_tok;
      
      console.log("current_tok:",current_tok);
      queue_token_no.shift();
      myvideoid=videoId;
      console.log("myvideoid",myvideoid);
      //updateSongs();
      player = new YT.Player('player', {
        height: '260',
        width: '440',
        videoId: videoId,
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
      updateQueueDisplay();
    }
  }

  function getYouTubeVideoId(link) {
    var videoId = link.split('v=')[1];
    var ampersandPosition = videoId.indexOf('&');
    if (ampersandPosition !== -1) {
      videoId = videoId.substring(0, ampersandPosition);
    }
    return videoId;
  }

  function setVideoPlayed(videoId) {
    $.ajax({
      type: 'POST',
      url: '/update-queueisplayed/',
      data: {
        'song_link': videoId,
        'csrfmiddlewaretoken': '{{ csrf_token }}',
      },
      success: function(response) {
        console.log(response);
      },
      error: function(xhr, status, error) {
        console.error(xhr.responseText);
      }
    });
  }

  function onPlayerReady(event) {
    event.target.playVideo();
  }
  
  function isVideoPlaying() {
    if (player) {
      return player.getPlayerState() === 1;
    } else {
      return false;
    }
  }
  setInterval(function() {
    if (player && player.getPlayerState() === 2) {
      // Video is paused, do nothing
    } else if (!isVideoPlaying()) {
      location.reload();
    }
  }, 5000);
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.ENDED) {
      event.target.destroy();
      setVideoPlayed(myvideoid);
      updateSongs();
      //playNextVideo();
    }
  }

  function updateSongs() {
    fetch('/get-songs/')
        .then(response => response.json())
        .then(data => {
            var nsongs = data.newsongs;
            // clear the queue
            queue = [];
            queue_token_no = [];
            // update the songs and queue variables
            nsongs.forEach(song => {
                var text = song[0];
                var videoId = getYouTubeVideoId(text);
                queue.push(videoId);
                queue_token_no.push(song[3]);
            });
            console.log('Songs updated:', queue);
        })
        .catch(error => {
            console.log('Error updating songs:', error);
        });
  }


  async function getVideoName(videoId) {
    try {
      const apiUrl = "https://www.googleapis.com/youtube/v3/videos";
      const params = {
        id: videoId,
        key: "AIzaSyCNtdk5YQKiONdmp1E3HZNZsmrAs1xBY5o",
        part: "snippet"
      };
  
      const response = await fetch(apiUrl + "?" + new URLSearchParams(params));
      const data = await response.json();
  
      if (data.items.length > 0) {
        const videoName = data.items[0].snippet.title;
        return videoName;
      } else {
        return "Unknown Video";
      }
    } catch (error) {
      console.log("Error fetching video title:", error);
      return "Unknown Video";
    }
  }
  
  async function updateQueueDisplay() {
    var queueElement = document.getElementById("queue");
    queueElement.innerHTML = ""; // Clear the existing queue
  
    for (var i = 0; i < queue.length; i++) {
      var videoId = queue[i];
      var tokenNo = queue_token_no[i];
  
      try {
        var videoName = await getVideoName(videoId);
        var videoLink = "https://www.youtube.com/watch?v=" + videoId;
  
        var listItem = document.createElement("li");
        var link = document.createElement("a");
        link.href = videoLink;
        link.textContent = tokenNo + " - " + videoName;
  
        var blacklistButton = document.createElement("button");
        blacklistButton.textContent = "Blacklist";
        blacklistButton.addEventListener("click", (function(videoLink) {
          return function() {
            addToBlacklist2(videoLink);
          };
        })(videoLink));
  
        var removeButton = document.createElement("button");
        removeButton.textContent = "Remove";
        removeButton.addEventListener("click", (function(videoIdToRemove) {
          return function() {
            setVideoPlayed(videoIdToRemove);
          };
        })(getYouTubeVideoId(videoLink)));
  
        listItem.appendChild(link);
        listItem.appendChild(blacklistButton);
        listItem.appendChild(removeButton);
        queueElement.appendChild(listItem);
      } catch (error) {
        console.log("Error fetching video name:", error);
        // Handle error case if necessary
      }
    }
  }
  
  

  function toggleCafeStatus() {
    var activeBtn = document.getElementById("active-btn");
    var isActive = activeBtn.textContent === "Active";
    fetch("{% url 'update_cafe_status' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ "is_active": !isActive })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          var cafe = data.cafe;
          activeBtn.textContent = cafe.is_active ? "Active" : "Inactive";
          if (cafe.is_active) {
            console.log("Cafe is currently active");
          } else {
            console.log("Cafe is not currently active");
          }
        } else {
          console.error(data.error);
        }
      })
      .catch(error => console.error(error));
  }

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      var cookies = document.cookie.split(";");
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function addToBlacklist() {
    var youtubeLink = document.getElementById("blacklist-link").value;
    $.ajax({
        type: "POST",
        url: "/api/add-to-blacklist/",
        data: {
            youtube_link: youtubeLink,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("Link has been added to the blacklist");
            } else {
                alert("Error: " + response.error);
            }
        }
    });
  }

  function addToBlacklist2(youtubeLink) {
    $.ajax({
        type: "POST",
        url: "/api/add-to-blacklist2/",
        data: {
            youtube_link: youtubeLink,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("Link has been added to the blacklist");
            } else {
                alert("Error: " + response.error);
            }
        }
    });
  }
  document.addEventListener("DOMContentLoaded", function() {
    Refresh();
  });
  document.getElementById("active-btn").addEventListener("click", toggleCafeStatus);
</script>
{% endblock %}
</body>
</html>
